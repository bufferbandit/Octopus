<!doctype html>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@4.5.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@4.5.0/lib/xterm.js"></script> 
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.3.0/lib/xterm-addon-fit.js"></script>             </head>
<body>
    <div id="terminal"></div>
    <script>
        
        const term = new Terminal(),
        f = new FitAddon.FitAddon();
        term.loadAddon(f);
        term.open(document.getElementById('terminal'));

        const width = window.innerWidth - 230;
        const height = window.innerHeight - 140;
        cols = parseInt(width / 9, 10);
        //term.fit();
        term.resize(cols, parseInt(height / 17, 10));
        term.scrollToBottom();

        var prev_line = '';

        function runFakeTerminal() {
            if (term._initialized) {
                return;
            }
            term._initialized = true;
            term.prompt = () => {
                term.write('\\r\\n\\x1b[4mOctopus\\x1b[0m\\x1b[32m >>\\x1b[0m ');
            };
            prompt(term);
            var buff = Array()
            term.onData(e => {
                switch (e) {
                    case '\\r':
                        var command = buff.join("")
                        loadAndWrite(command)
                        buff.length = 0;
                    case '\\u0003':
                        prompt(term);
                        break;
                    case '\\u007F':
                        if (term._core.buffer.x > 11) {
                            buff.pop()
                            term.write('\\b \\b');
                        }
                        break;
                    default:
                        term.write(e);
                        buff.push(e)
                }
            })
        }

        function loadAndWrite(command) {
            prev_line = command
            var formData = new FormData();
            formData.append("input", command)
            fetch(window.location.href, {
                method: "POST",
                body: formData,
            }).then((response) => {
                response.text()
                    .then( raw => raw.replace(/\\n/g, '\\n\\r') )
                    .then( data => term.write(data) )  
            })
        }

        function prompt(term) {
            term.write('\\r\\n\\x1b[4mOctopus\\x1b[0m\\x1b[32m >>\\x1b[0m ');
        }
        runFakeTerminal();
    </script>
</body>
</html>